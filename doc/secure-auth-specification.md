# セキュア認証システム仕様書

## 概要

StudySphereアプリケーションのセキュア認証システムの仕様を定義します。このシステムは、JWT（JSON Web Token）を使用した二重トークン認証方式を採用し、セキュリティとユーザビリティのバランスを考慮した設計となっています。

## 認証アーキテクチャ

### トークン構成
- **アクセストークン（Access Token）**: APIリクエスト用の短期トークン
- **リフレッシュトークン（Refresh Token）**: アクセストークン更新用の長期トークン

### トークン寿命設定

| トークン種別 | 寿命 | 用途 |
|-------------|------|------|
| アクセストークン | 1時間 | APIリクエスト認証 |
| リフレッシュトークン | 当日23:59まで | アクセストークン更新（ログイン継続用） |

## フロントエンド実装仕様

### 1. トークン管理

#### 1.1 トークン保存
```javascript
// localStorage に保存
localStorage.setItem('accessToken', accessToken);
localStorage.setItem('refreshToken', refreshToken);
localStorage.setItem('refreshTokenCreated', Date.now().toString());
```

#### 1.2 リフレッシュトークン寿命管理
```javascript
export const isRefreshTokenExpired = (refreshToken) => {
  const creationTime = localStorage.getItem('refreshTokenCreated');
  // 日本時間の当日23:59:59を計算
  const now = new Date();
  const japanTime = new Date(now.getTime() + (9 * 60 * 60 * 1000)); // UTC+9
  const todayEnd = new Date(japanTime.getFullYear(), japanTime.getMonth(), japanTime.getDate(), 23, 59, 59);
  const todayEndUTC = new Date(todayEnd.getTime() - (9 * 60 * 60 * 1000)); // UTCに戻す
  
  const creationDate = new Date(parseInt(creationTime));
  return now > todayEndUTC; // 当日23:59まで有効
};
```

### 2. 更新チェック仕様

#### 2.1 チェック間隔
- **頻度**: 5分毎（300秒間隔）
- **閾値**: 30分（1800秒）以下で更新判定

#### 2.2 更新判定ロジック
```javascript
export const shouldRefreshToken = (token) => {
  const remainingTime = getTokenExpiryTime(token);
  return remainingTime <= 30 * 60; // 30分以下で更新（1800秒）
};
```

### 3. 更新試行制限

#### 3.1 試行回数制限
- **最大試行回数**: 10回
- **制限超過時**: ログインページにリダイレクト

#### 3.2 実装例
```javascript
const MAX_REFRESH_ATTEMPTS = 10;
let refreshAttempts = 0;

if (refreshAttempts >= MAX_REFRESH_ATTEMPTS) {
  handleTokenInvalid(navigate, 'トークン更新の試行回数が上限に達しました');
  return;
}
```

### 4. HTTPインターセプター

#### 4.1 自動トークン更新
- 401/403エラー時に自動的にリフレッシュトークンで更新を試行
- 更新成功時は元のリクエストを再実行
- 更新失敗時はログインページにリダイレクト

#### 4.2 リフレッシュトークン期限切れチェック
```javascript
if (isRefreshTokenExpired(refreshToken)) {
  handleTokenInvalid(navigate, 'リフレッシュトークンの有効期限が切れました');
  throw new Error('Refresh token expired');
}
```

## バックエンド実装仕様

### 1. JWT設定

#### 1.1 環境変数
```env
JWT_SECRET=5717beb0435d9de18748f91fc0be629371b2ef694d79689fb60b0764724981fc1db009971e523783bbb6313bb9f45e39f2393dbfc845abeac55df03cef39ae52
```

#### 1.2 トークン生成
- **アクセストークン**: 1時間有効
- **リフレッシュトークン**: 当日23:59まで有効

### 2. データベース設定

#### 2.1 接続設定
```env
DB_HOST=db
DB_USER=root
DB_PASSWORD=password
DB_NAME=myapp
DB_PORT=3306
```

#### 2.2 リフレッシュトークン管理
- リフレッシュトークンの保存と削除
- トークンの有効性検証
- 古いトークンの自動クリーンアップ

## セキュリティ対策

### 1. トークンセキュリティ

#### 1.1 適切なトークン寿命
- **目的**: セキュリティと利便性のバランス
- **効果**: 長時間作業時の継続的な認証を保証

#### 1.2 更新試行回数制限
- **目的**: ブルートフォース攻撃対策
- **効果**: 無限ループと攻撃の防止（適度な制限）

### 2. エラーハンドリング

#### 2.1 段階的エラー処理
1. ネットワークエラー: リダイレクトしない
2. 認証エラー: トークン更新を試行
3. 更新失敗: ログインページにリダイレクト

#### 2.2 詳細ログ出力
- トークン更新の試行回数
- エラーの詳細情報
- セキュリティ監査の強化

### 3. セッション管理

#### 3.1 自動ログアウト
- リフレッシュトークン期限切れ時
- 更新試行回数上限到達時
- 不正なトークン検出時

#### 3.2 セッションクリーンアップ
- ログアウト時のトークン削除
- 関連データの完全クリア

## パフォーマンス最適化

### 1. 効率的なチェック頻度
- 5分間隔でのチェック
- 30分閾値での更新判定
- 不要な更新リクエストの削減

### 2. メモリ管理
- トークン情報の適切な保存
- 不要なデータの自動クリーンアップ
- メモリリークの防止

## 運用・監視

### 1. ログ監視

#### 1.1 監視項目
- トークン更新の成功/失敗率
- 更新試行回数の統計
- エラーパターンの分析

#### 1.2 アラート設定
- 更新失敗率の異常値検出
- セキュリティイベントの通知
- システム障害の早期発見

### 2. メトリクス

#### 2.1 パフォーマンス指標
- 平均レスポンス時間
- トークン更新の処理時間
- データベース接続の状況

#### 2.2 セキュリティ指標
- 不正アクセスの検出数
- トークン漏洩の疑い
- 攻撃パターンの分析

## トラブルシューティング

### 1. よくある問題

#### 1.1 トークン更新失敗
- **原因**: リフレッシュトークン期限切れ
- **対処**: 再ログインを促す

#### 1.2 無限ループ
- **原因**: 更新試行回数制限の不備
- **対処**: 制限値の確認と調整

#### 1.3 パフォーマンス低下
- **原因**: 過度な更新チェック
- **対処**: チェック間隔の調整

### 2. デバッグ方法

#### 2.1 ログ確認
```javascript
console.log('トークン更新試行:', refreshAttempts);
console.log('リフレッシュトークン有効期限:', isExpired);
console.log('アクセストークン残り時間:', remainingTime);
```

#### 2.2 ブラウザ開発者ツール
- Network タブでのリクエスト確認
- Application タブでのトークン確認
- Console タブでのエラーログ確認

## 今後の改善案

### 1. セキュリティ強化
- トークンの暗号化強化
- 多要素認証の導入
- セッション固定化攻撃対策

### 2. パフォーマンス向上
- トークンキャッシュの最適化
- 非同期更新処理の実装
- 分散環境での同期

### 3. 監視強化
- リアルタイム監視ダッシュボード
- 機械学習による異常検出
- 自動復旧機能の実装

## まとめ

このセキュア認証システムは、以下の特徴を持つ堅牢な認証基盤を提供します：

1. **セキュリティ**: 短いトークン寿命と更新制限による攻撃対策
2. **ユーザビリティ**: 自動更新によるシームレスな体験
3. **パフォーマンス**: 効率的なチェック頻度とメモリ管理
4. **運用性**: 詳細なログと監視機能

この仕様に基づいて実装されたシステムは、セキュリティと利便性の両立を実現し、安全で使いやすいアプリケーションを提供します。 