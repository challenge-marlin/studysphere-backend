# 一時パスワード機能の使用方法

## 概要
利用者ダッシュボードの自動ログイン機能を修正し、支援アプリから送られてきたログインコードと一時パスワードによる認証を実装しました。また、**支援アプリへの自動通知機能**も追加しました。

## 機能

### 1. 一時パスワード発行
- 利用者（ロール1）に対して一時パスワードを発行
- 既存の一時パスワードは自動的に無効化
- 有効期限は当日の23:59:59まで
- **支援アプリへの自動通知送信**

### 2. 一時パスワード検証
- ログインコードと一時パスワードによる認証
- 有効期限チェック
- 使用済みチェック
- 認証成功時にパスワードを使用済みにマーク

### 3. フロントエンドログイン
- ログインコードと一時パスワード入力フォーム
- URLパラメータからのログインコード自動取得
- エラーハンドリングとユーザーフィードバック

### 4. 支援アプリ通知機能 ⭐ **新機能**
- 一時パスワード発行時に支援アプリに自動通知
- 支援アプリで通知ダイアログを表示
- ログインコードと一時パスワードをクリップボードに自動コピー
- 5秒間隔での通知監視

## API エンドポイント

### 一時パスワード発行
```
POST /api/users/:userId/issue-temp-password
```

### 一時パスワード検証
```
POST /api/users/verify-temp-password
Content-Type: application/json

{
  "loginCode": "ログインコード",
  "tempPassword": "一時パスワード"
}
```

### 支援アプリ通知関連 ⭐ **新機能**
```
POST /api/remote-support/notify-temp-password
Content-Type: application/json

{
  "loginCode": "ログインコード",
  "tempPassword": "一時パスワード",
  "userName": "利用者名",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

```
GET /api/remote-support/get-temp-password-notification/:loginCode
```

## 使用方法

### 1. 一時パスワード発行（管理者・指導員）
1. 管理画面から利用者を選択
2. 一時パスワード発行ボタンをクリック
3. 生成されたログインコードと一時パスワードが**自動的に支援アプリに送信される**

### 2. 支援アプリでの通知受信 ⭐ **新機能**
1. 支援アプリが起動中の場合、一時パスワード発行時に通知ダイアログが表示される
2. 通知ダイアログには以下が表示される：
   - 利用者名
   - ログインコード
   - 一時パスワード
3. 「コピー」ボタンでログインコードと一時パスワードをクリップボードにコピー
4. 自動的にクリップボードにコピーされる（1秒後）

### 3. 利用者ログイン
1. フロントエンドの利用者ログインページにアクセス
   - 直接アクセス: `http://localhost:3000/student-login`
   - URLパラメータ付き: `http://localhost:3000/student-login?code=ログインコード`
2. ログインコードと一時パスワードを入力
3. ログインボタンをクリック
4. 認証成功時に利用者ダッシュボードにリダイレクト

## 起動方法

### PowerShellでの起動問題解決
PowerShellで`&&`演算子が使用できない場合、以下のバッチファイルを使用してください：

#### 方法1: バッチファイルを使用（推奨）
```bash
# バックエンド起動
start-backend.bat

# フロントエンド起動（別のターミナルで）
start-frontend.bat

# 支援アプリ起動（別のターミナルで）
start-remote-support.bat
```

#### 方法2: PowerShellで個別に実行
```powershell
# バックエンド
cd studysphere-backend
npm start

# フロントエンド（別のターミナルで）
cd studysphere-frontend
npm start

# 支援アプリ（別のターミナルで）
cd remote-support
npm start
```

#### 方法3: 手動でディレクトリ移動
```powershell
# バックエンド
Set-Location studysphere-backend
npm start

# フロントエンド（別のターミナルで）
Set-Location studysphere-frontend
npm start

# 支援アプリ（別のターミナルで）
Set-Location remote-support
npm start
```

## 依存関係のインストール

### バックエンド
```bash
cd studysphere-backend/backend
npm install
```

### フロントエンド
```bash
cd studysphere-frontend
npm install
```

### 支援アプリ
```bash
cd remote-support
npm install
```

## テスト方法

### バックエンドテスト
```bash
cd studysphere-backend
node test-temp-password.js
```

### フロントエンドテスト
1. ブラウザで `http://localhost:3000/student-login` にアクセス
2. 以下のテストデータを使用：
   - ログインコード: `byg3-6b8u-rQxN`
   - 一時パスワード: `JRKXMB`（テスト実行時に生成される）

### 支援アプリ通知テスト ⭐ **新機能**
1. 支援アプリを起動
2. ログインコードでログイン
3. 管理画面から一時パスワードを発行
4. 支援アプリに通知ダイアログが表示されることを確認

## セキュリティ考慮事項

1. **一時パスワードの有効期限**: 当日の23:59:59まで
2. **使用済みチェック**: 一度使用したパスワードは再使用不可
3. **自動無効化**: 新しいパスワード発行時に既存パスワードを無効化
4. **ロール制限**: 利用者（ロール1）のみが対象
5. **通知セキュリティ**: 通知データはメモリに一時保存（本番環境ではRedis推奨）

## トラブルシューティング

### よくある問題

1. **「ユーザーが見つかりません」エラー**
   - ログインコードが正しいか確認
   - 利用者が存在し、ステータスが有効か確認

2. **「パスワードの有効期限が切れています」エラー**
   - 新しい一時パスワードを発行

3. **「このパスワードは既に使用されています」エラー**
   - 新しい一時パスワードを発行

4. **「ログインコードまたはパスワードが正しくありません」エラー**
   - 入力値の確認
   - 大文字・小文字の区別に注意

5. **支援アプリに通知が届かない** ⭐ **新機能**
   - 支援アプリが起動しているか確認
   - ログインコードでログインしているか確認
   - バックエンドのログで通知送信エラーを確認

6. **PowerShellで`&&`演算子エラー**
   - バッチファイルを使用する
   - 個別にコマンドを実行する
   - `Set-Location`を使用する

7. **`window.electronAPI.getTempPasswordNotification is not a function`エラー**
   - 支援アプリを再起動する
   - preload.jsが正しく読み込まれているか確認
   - main.jsで関数が正しくインポートされているか確認

8. **axios関連のエラー**
   - `npm install axios`を実行
   - package.jsonにaxiosが含まれているか確認

### ログ確認
バックエンドのログで詳細なエラー情報を確認できます。

### デバッグ手順
1. すべてのサービスが起動しているか確認
2. ブラウザの開発者ツールでコンソールエラーを確認
3. 支援アプリのログを確認
4. バックエンドのログを確認

## 今後の改善点

1. **自動ログイン機能の強化**: セキュリティを考慮した自動ログイン
2. **パスワード強度の向上**: より複雑なパスワード生成
3. **通知機能の強化**: プッシュ通知、メール通知
4. **監査ログ**: パスワード使用履歴の記録
5. **通知データの永続化**: Redisやデータベースでの通知データ管理
6. **エラーハンドリングの改善**: より詳細なエラーメッセージ
7. **起動スクリプトの改善**: より簡単な起動方法
