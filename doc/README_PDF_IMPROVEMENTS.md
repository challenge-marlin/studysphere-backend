# PDF処理の改善 - ハング問題の解決

## 概要
PDFからTXTへの変換処理で発生していたハング（フリーズ）問題を解決するため、以下の改善を実装しました。

## 実装した改善点

### 1. フロントエンド（TextSection.js）

#### タイムアウト設定の延長
- フロントエンドのタイムアウトを5分から15分に延長
- 大きなPDFファイルの処理に対応

### 2. バックエンド（learningRoutes.js）

#### 無限ループの防止
- `useEffect`の依存配列から`pdfTextContent`を削除
- 処理済みのS3キーを記録して重複処理を防止
- `processedS3KeyRef`を使用した状態管理の改善

#### タイムアウト処理の追加
- 5分のタイムアウト処理を実装
- `AbortController`を使用した処理のキャンセル機能
- タイムアウト時の適切なエラーメッセージ表示

#### エラーハンドリングの改善
- 処理中の状態管理の強化
- エラーメッセージの詳細表示
- 再試行機能の実装
- キャンセルボタンの追加

#### メモリ管理の改善
- コンポーネントアンマウント時のクリーンアップ
- タイムアウトタイマーの適切な管理
- AbortControllerのリソース解放

### 2. バックエンド（learningRoutes.js）

#### APIエンドポイントの改善
- リクエスト全体のタイムアウト処理（15分に延長）
- S3ダウンロードのタイムアウト処理（5分に延長）
- 処理時間の詳細ログ出力
- エラータイプに応じた適切なHTTPステータスコード

#### PDF処理関数の強化
- ファイルサイズ制限（100MB）
- テキスト長制限（1MB）
- 処理時間の監視とタイムアウト（10分に延長）
- メモリクリーンアップ（ガベージコレクション）
- 複数のPDF処理ライブラリ対応（pdf-parse, pdfjs-dist, pdf2pic）
- 段階的処理による大きなファイルへの対応

#### エラーハンドリングの詳細化
- タイムアウトエラーの適切な処理
- ファイルサイズエラーの明確化
- S3ダウンロードエラーの分離
- 処理時間の記録と分析

### 3. サーバー設定（index.js）

#### タイムアウト設定の追加
- サーバータイムアウト: 10分
- Keep-aliveタイムアウト: 65秒
- ヘッダータイムアウト: 66秒

## 使用方法

### フロントエンド
```javascript
// PDF処理の状態を監視
const [isPdfProcessing, setIsPdfProcessing] = useState(false);
const [pdfProcessingError, setPdfProcessingError] = useState(null);

// 処理のキャンセル
const cancelPdfProcessing = () => {
  if (abortControllerRef.current) {
    abortControllerRef.current.abort();
  }
};
```

### バックエンド
```javascript
// PDF処理のタイムアウト設定
const maxProcessingTime = 4 * 60 * 1000; // 4分

// ファイルサイズ制限
const maxFileSize = 100 * 1024 * 1024; // 100MB

// テキスト長制限
const maxTextLength = 1024 * 1024; // 1MB
```

## テスト

### テストスクリプトの実行
```bash
cd studysphere-backend/backend/scripts
node test-pdf-processing.js
```

### テスト内容
1. 正常なPDF処理
2. タイムアウト処理の動作確認
3. ファイルサイズ制限の動作確認
4. メモリ使用量の監視

## 設定可能なパラメータ

### タイムアウト設定
- フロントエンド: 15分（延長）
- バックエンドAPI: 15分（延長）
- PDF処理: 10分（延長）
- S3ダウンロード: 5分（延長）
- サーバー全体: 10分

### ファイル制限
- PDFファイルサイズ: 100MB
- 抽出テキスト長: 1MB

### リトライ設定
- 最大リトライ回数: 3回
- 指数バックオフ: 2秒、4秒、6秒

## 監視とログ

### ログ出力項目
- 処理開始・完了時刻
- ファイルサイズ
- 処理時間
- エラー詳細
- メモリ使用量

### エラーコード
- 408: リクエストタイムアウト
- 413: ファイルサイズ制限超過
- 500: 内部サーバーエラー
- 503: サービス利用不可

## トラブルシューティング

### よくある問題と対処法

#### 1. タイムアウトが頻繁に発生する
- ファイルサイズを確認（100MB以下に制限）
- ネットワーク環境の確認
- サーバーのリソース状況確認

#### 2. メモリ使用量が高い
- ガベージコレクションの実行確認
- 大きなファイルの処理を避ける
- サーバーの再起動

#### 3. S3ダウンロードが失敗する
- AWS認証情報の確認
- ネットワーク接続の確認
- S3バケットの権限確認

## 今後の改善予定

### 短期
- 処理状況のプログレスバー表示
- より詳細なエラーメッセージ
- ユーザー設定可能なタイムアウト値

### 長期
- 非同期処理のキュー管理
- 分散処理による負荷分散
- キャッシュ機能の実装

## 注意事項

1. **ファイルサイズ制限**: 100MBを超えるPDFファイルは処理できません
2. **処理時間**: 大きなファイルは処理に時間がかかる場合があります
3. **メモリ使用量**: 処理中は一時的にメモリ使用量が増加します
4. **ネットワーク**: 安定したネットワーク接続が必要です

## サポート

問題が発生した場合は、以下の情報を収集して報告してください：

1. エラーログ
2. ファイルサイズ
3. 処理時間
4. メモリ使用量
5. ネットワーク環境
